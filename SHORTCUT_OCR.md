# iOS 快捷指令 - 截图 OCR 记账方案

## 问题背景

iOS 16.1+ 限制了快捷指令读取通知的权限，微信/支付宝支付通知无法直接捕获。

**替代方案：截图 OCR 识别**

---

## 方案一：截图识别（推荐）

### 使用流程：

```
1. 微信/支付宝支付完成
2. 停留在支付成功页面
3. 截图（电源键+音量上）
4. 快捷指令自动识别并记账
```

### 快捷指令配置：

**触发方式：**
- 方式 A：截图后自动触发（需设置自动化）
- 方式 B：双击背面触发
- 方式 C：悬浮球/辅助触控触发

**快捷指令步骤：**

```
1. 获取最新截图
   └── 获取最新的照片（1张）
       
2. 识别文字
   └── 从图像中提取文本
       
3. 提取金额
   └── 匹配文本：¥([0-9]+\.?[0-9]*) 或 ([0-9]+\.?[0-9]*)元
       └── 获取第一个匹配 → 变量「金额」
       
4. 提取商家
   └── 匹配文本：支付给(.+?)[，。] 或 向(.+?)付款
       └── 获取第一个匹配 → 变量「商家」
       
5. 打开记账 App
   └── 打开 URL：
       accounting://add?amount=[金额]&merchant=[商家]&source=ocr
```

---

## 方案二：双击背面触发

### 设置步骤：

1. 打开「设置」→「辅助功能」→「触控」→「轻点背面」
2. 选择「轻点两下」或「轻点三下」
3. 选择「快捷指令」→「自动记账」

### 使用流程：

```
1. 支付完成后停留在支付页面
2. 双击手机背面
3. 快捷指令自动截图 → 识别 → 打开记账 App
```

---

## 方案三：辅助触控（悬浮球）

### 设置步骤：

1. 打开「设置」→「辅助功能」→「触控」→「辅助触控」
2. 开启「辅助触控」（出现悬浮球）
3. 设置「轻点两下」或「长按」为「运行快捷指令」
4. 选择「自动记账」快捷指令

---

## 方案四：手动触发（最稳定）

### 快捷指令配置：

```
1. 要求输入（金额）
   └── 数字键盘
   
2. 要求输入（商家）
   └── 文本键盘
   
3. 从列表中选择（分类）
   └── 餐饮、交通、购物...
   
4. 打开 URL：
   accounting://add?amount=[金额]&merchant=[商家]&category=[分类]
```

### 使用方式：

- 每次支付后手动运行快捷指令
- 输入金额和商家（或从剪贴板粘贴）
- 自动打开记账 App

---

## OCR 识别优化建议

### 提高识别率：

1. **截图范围** - 尽量只截支付信息区域，避免多余内容
2. **清晰截图** - 确保金额和商家文字清晰可见
3. **正则优化** - 根据实际截图调整匹配规则

### 常用正则：

```
金额匹配：
- ¥([0-9]+\.?[0-9]*)
- ([0-9]+\.?[0-9]*)元
- 支付成功([0-9]+\.?[0-9]*)

商家匹配：
- 支付给(.+?)[，。]
- 向(.+?)付款
- 商户名称[：:](.+?)[\n]
- 收款方[：:](.+?)[\n]
```

---

## 快捷指令示例（截图 OCR 版）

```
┌─────────────────────────────────────┐
│  快捷指令：自动记账（OCR）            │
├─────────────────────────────────────┤
│  1. 获取最新的照片（1张）             │
│     └── 限制：最近1张                │
├─────────────────────────────────────┤
│  2. 从图像中提取文本                  │
│     └── 语言：简体中文               │
├─────────────────────────────────────┤
│  3. 匹配文本（金额）                  │
│     └── 模式：¥([0-9]+\.?[0-9]*)     │
│     └── 获取：第一个匹配             │
│     └── 设为变量：金额               │
├─────────────────────────────────────┤
│  4. 匹配文本（商家）                  │
│     └── 模式：支付给(.+?)[，。]      │
│     └── 获取：第一个匹配             │
│     └── 设为变量：商家               │
├─────────────────────────────────────┤
│  5. 如果「金额」有值                  │
│     └── 打开 URL：                   │
│         accounting://add?            │
│         amount=[金额]                │
│         &merchant=[商家]             │
│         &source=screenshot           │
│     └── 否则：                       │
│         显示提示：未能识别金额        │
└─────────────────────────────────────┘
```

---

## 测试方法

1. 在微信/支付宝完成一笔支付
2. 停留在支付成功页面
3. 截图
4. 运行快捷指令
5. 检查是否正确识别金额和商家

如果识别失败：
- 检查截图是否包含金额和商家信息
- 调整正则表达式匹配规则
- 使用「显示结果」调试，查看识别的完整文本

---

## 总结

| 方案 | 自动化程度 | 准确性 | 推荐度 |
|------|-----------|--------|--------|
| 通知监听 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ❌ 已不可用 |
| 截图 OCR | ⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ 推荐 |
| 双击背面 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ 推荐 |
| 手动输入 | ⭐ | ⭐⭐⭐⭐⭐ | ✅ 最稳定 |

**建议组合使用：**
- 日常小额：截图 OCR / 双击背面
- 大额重要：手动输入确保准确
